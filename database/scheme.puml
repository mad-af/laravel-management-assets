@startuml
!define table(x) class x << (T,#FFAAAA) >>
!define pk(x) <u>x</u>
!define fk(x) <i>x</i>

title Laravel Asset Management System - ERD (Multi-tenant) + Asset Transfer (MVP) + Vehicle (MVP) + Service Log Enhancements

' ==========================
' Company / Tenant Table
' ==========================
table(companies) {
  pk(id) : UUID
  name : VARCHAR [UNIQUE]
  code : VARCHAR [UNIQUE]
  fk(location_id) : UUID [NULL]
  tax_id : VARCHAR [NULL]
  address : TEXT [NULL]
  phone : VARCHAR [NULL]
  email : VARCHAR [NULL]
  website : VARCHAR [NULL]
  is_active : BOOLEAN [DEFAULT: true]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' ==========================
' Main Business Tables
' ==========================
table(users) {
  pk(id) : UUID
  fk(company_id) : UUID
  name : VARCHAR
  email : VARCHAR [UNIQUE]
  role : ENUM(admin, staff, auditor) [DEFAULT: staff]
  email_verified_at : TIMESTAMP [NULL]
  password : VARCHAR
  remember_token : VARCHAR [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

table(categories) {
  pk(id) : UUID
  fk(company_id) : UUID
  name : VARCHAR [UNIQUE]
  is_active : BOOLEAN [DEFAULT: true]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

table(locations) {
  pk(id) : UUID
  name : VARCHAR [UNIQUE]
  is_active : BOOLEAN [DEFAULT: true]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

table(assets) {
  pk(id) : UUID
  fk(company_id) : UUID
  code : VARCHAR [UNIQUE]
  tag_code : VARCHAR [UNIQUE, NULL]
  name : VARCHAR
  fk(category_id) : UUID
  fk(location_id) : UUID
  status : ENUM(active, damaged, lost, maintenance, checked_out) [DEFAULT: active]
  condition : ENUM(excellent, good, fair, poor) [DEFAULT: good]
  value : DECIMAL(15,2)
  purchase_date : DATE [NULL]
  description : TEXT [NULL]
  last_seen_at : TIMESTAMP [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

table(asset_logs) {
  pk(id) : UUID
  fk(asset_id) : UUID
  fk(user_id) : UUID
  action : VARCHAR
  changed_fields : JSON [NULL]
  notes : TEXT [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

table(asset_loans) {
  pk(id) : UUID
  fk(asset_id) : UUID
  borrower_name : VARCHAR
  checkout_at : TIMESTAMP
  due_at : TIMESTAMP
  checkin_at : TIMESTAMP [NULL]
  condition_out : VARCHAR
  condition_in : VARCHAR [NULL]
  notes : TEXT [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' ============ UPDATED ============
' Service log untuk SEMUA aset; diperkuat untuk kendaraan
 table(asset_maintenances) {
  pk(id) : UUID
  fk(asset_id) : UUID
  title : VARCHAR
  type : ENUM(preventive, corrective)
  status : ENUM(open, scheduled, in_progress, completed, cancelled) [DEFAULT: open]
  priority : ENUM(low, medium, high, critical) [DEFAULT: medium]
  scheduled_at : TIMESTAMP [NULL]
  started_at : TIMESTAMP [NULL]
  completed_at : TIMESTAMP [NULL]
  cost : DECIMAL(15,2) [DEFAULT: 0.00]
  technician_name : VARCHAR [NULL]
  vendor_name : VARCHAR [NULL]
  notes : TEXT [NULL]
  ' ---- Vehicle-specific helpers (tanpa tabel baru)
  odometer_km_at_service : INT [NULL]
  next_service_target_odometer_km : INT [NULL]
  next_service_date : DATE [NULL]
  workshop_name : VARCHAR [NULL]
  invoice_no : VARCHAR [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' ==========================
' NEW: Asset Transfer (MVP)
' ==========================
 table(asset_transfers) {
  pk(id) : UUID
  fk(company_id) : UUID
  transfer_no : VARCHAR [UNIQUE]
  reason : VARCHAR [NULL]
  status : ENUM(draft, submitted, approved, executed, void) [DEFAULT: draft]
  type : ENUM(internal, external) [DEFAULT: internal]
  priority : ENUM(low, medium, high, urgent) [DEFAULT: medium]
  fk(from_location_id) : UUID [NULL]
  fk(to_location_id) : UUID [NULL]
  fk(requested_by) : UUID
  fk(approved_by) : UUID [NULL]
  scheduled_at : TIMESTAMP [NULL]
  executed_at : TIMESTAMP [NULL]
  notes : TEXT [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

 table(asset_transfer_items) {
  pk(id) : UUID
  fk(asset_transfer_id) : UUID
  fk(asset_id) : UUID
  fk(from_location_id) : UUID
  fk(to_location_id) : UUID
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

 table(asset_location_history) {
  pk(id) : UUID
  fk(asset_id) : UUID
  fk(from_location_id) : UUID [NULL]
  fk(to_location_id) : UUID
  changed_at : TIMESTAMP
  fk(changed_by) : UUID
  fk(transfer_id) : UUID [NULL]
  remark : VARCHAR [NULL]
}

' ==========================
' NEW: Vehicle (MVP)
' ==========================
 table(vehicle_profiles) {
  pk(asset_id) : UUID
  year_purchase : INT
  year_manufacture : INT
  current_odometer_km : INT [DEFAULT: 0]
  last_service_date : DATE [NULL]
  service_interval_km : INT [NULL]
  service_interval_days : INT [NULL]
  service_target_odometer_km : INT [NULL]
  next_service_date : DATE [NULL]
  annual_tax_due_date : DATE [NULL]
  plate_no : VARCHAR(32) [NULL]
  vin : VARCHAR(64) [NULL]
  brand : VARCHAR(64) [NULL]
  model : VARCHAR(64) [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

 table(vehicle_odometer_logs) {
  pk(id) : UUID
  fk(asset_id) : UUID
  reading_km : INT
  read_at : TIMESTAMP
  source : ENUM(manual, telematics, service) [DEFAULT: manual]
  notes : TEXT [NULL]
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' ==========================
' Relationships
' ==========================
companies ||--o{ users : "has many"
companies ||--o{ categories : "has many"
locations ||--o{ companies : "has many"
companies ||--o{ assets : "has many"
companies ||--o{ asset_transfers : "has many"

categories ||--o{ assets : "has many"
locations ||--o{ assets : "has many"
assets ||--o{ asset_logs : "has many"
assets ||--o{ asset_loans : "has many"
assets ||--o{ asset_maintenances : "has many"
users ||--o{ asset_logs : "creates"
users ||--o{ sessions : "has many"
users ||--o{ password_reset_tokens : "has many"

asset_transfers ||--o{ asset_transfer_items : "has many"
assets ||--o{ asset_location_history : "has many"
users ||--o{ asset_transfers : "requests/approves"

locations ||--o{ asset_transfers : "as from_location"
locations ||--o{ asset_transfers : "as to_location"
locations ||--o{ asset_transfer_items : "as from_location"
locations ||--o{ asset_transfer_items : "as to_location"
locations ||--o{ asset_location_history : "as from_location"
locations ||--o{ asset_location_history : "as to_location"

asset_transfers ||--o{ asset_location_history : "writes"

assets ||--|| vehicle_profiles : "has one"
assets ||--o{ vehicle_odometer_logs : "has many"

' ==========================
' Notes
' ==========================
note right of asset_maintenances
  Service log utama untuk semua aset.
  Tambahan kolom mendukung kendaraan tanpa tabel baru:
  - odometer_km_at_service
  - next_service_target_odometer_km
  - next_service_date
  - workshop_name, invoice_no
  Saat status completed:
  - update vehicle_profiles.last_service_date
  - hitung ulang target km/tanggal servis berikutnya
end note

note right of vehicle_profiles
  Detail khusus aset kendaraan (category = vehicle)
  Menyimpan odometer terkini, tahun beli/manufacture, servis & pajak
end note

note right of vehicle_odometer_logs
  Riwayat pembacaan odometer (manual/telematics/service)
  Berguna untuk audit dan trigger preventive maintenance
end note

@enduml
